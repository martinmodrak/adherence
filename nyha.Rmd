---
title: "NYHA"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(readxl)
library(here)
library(cowplot)
```

```{r}
main_data <- read_excel(here("private_data","Spiroergometrie - soubor pacientů 27.2. - kopie pro statistiku.xlsx"), sheet ="Seznam pacientů", range = "BJ2:BL94") 

id <- read_excel(here("private_data","Spiroergometrie - soubor pacientů 27.2. - kopie pro statistiku.xlsx"), sheet ="Seznam pacientů", range = "A2:A94")

adherence <- read_excel(here("private_data","Spiroergometrie - soubor pacientů 27.2. - kopie pro statistiku.xlsx"), sheet ="List1", range = "F2:F93", col_names = "Adherence") 


NYHA_VO2max_threshold = c(0, 10-1e-6, 16, 20+1e-6, 1000)

data <- cbind(id,main_data, adherence) %>%
  mutate(Adherence = factor(Adherence, levels = c(1:6), labels = c("Plně adherentní","Pravděpodobně adherentní","Možná neadherentní","Částečně neadherentní","Pravděpodobně neadherentní","Plně neadherentní"))) %>%
  rename(`NYHA spiro` = `NYHA dle spiroergometrie v minulosti`, `NYHA subj.` = `NYHA v minulosti`) %>%
  mutate(`NYHA vypočteno` = data$VO2max %>% cut(NYHA_VO2max_threshold, labels = 4:1, right = FALSE) %>% as.character() %>% as.numeric())

data %>% filter(`NYHA vypočteno` != `NYHA spiro`) %>% select(-`NYHA subj.`,-Adherence)
      
```

Data obsahují `r nrow(data)` pacientů.

```{r}
breaks <- c(2:4 - 0.5)
jitter_size <- 0.2
exp_limits <- c(1 - jitter_size - 0.1, 4 + jitter_size + 0.1)
data %>% ggplot(aes(x = `NYHA subjektivně`, y = `NYHA objektivně`, color = Adherence, fill = Adherence, group = Adherence)) + 
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm", alpha = 0.15) + 
  geom_jitter(width = jitter_size, height = jitter_size, size = 2) +
  scale_x_continuous(minor_breaks = breaks) +
  scale_y_continuous(minor_breaks = breaks) +
  expand_limits(x = exp_limits, y = exp_limits) +
  theme(panel.grid.minor = element_line(colour = "lightgray"))
```

Co tečka, to pacient, umístění v rámci obdélníků je náhodné. Barevné čáry - proložený trend zvlášť pro každou skupinu - pás kolem je nejistota, v zásadě jsou všechny přímky ležící uvnitř pásu konzistentní s daty. Černá šikmá čára je "ideální trend", kdyby objektivní a subjektivní měřily tu samou věc a jejich rozdíly byl jen náhodný šum, tak by proložený trend měl ležet na černé čáře. Z toho, že jsou od černé čáry dost daleko lze usoudit, že rozdíl je systematický.
Naopak vidíme, že adherentní a neadherentní pacienti mají trend téměř totožný.


```{r}
data %>% group_by(Adherence) %>% summarise(korelace = cor(`NYHA subjektivně`,`NYHA objektivně`)) %>%
  rbind(data %>% summarise(korelace = cor(`NYHA subjektivně`,`NYHA objektivně`)) %>% mutate(Adherence = "Vše"))
```


Dotazy:
- 
- Podrobnější data (spirometrie, detaily adherence)
- 
---
title: "Adherence"
output: html_document
---

```{r setup, message=FALSE, echo = FALSE, results='hide', warning = FALSE}
library(tidyverse)
library(readxl)
library(UpSetR)
library(brms)
library(cmdstanr)
library(bayesplot)
library(tidybayes)
library(ggdist)

knitr::opts_chunk$set(echo=FALSE)

document_output <- isTRUE(getOption('knitr.in.progress'))

if(document_output) {
  table_format <- function(x, caption = NULL, align = NULL) { 
    knitr::kable(x, caption = caption, align = align) 
  }
} else {
  table_format <- function(x, caption = NULL, align = NULL) { x }
}


options(mc.cores = 4, brms.backend = "cmdstanr", dplyr.summarise.inform = FALSE)
cache_dir <- here::here("stored_fits")
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

theme_set(cowplot::theme_cowplot())

run_pp_checks <- FALSE

devtools::load_all()

source(here::here("data_into_session.R"))
```

Following subjects have discrepancy between the "MÃ¡ XX" column and measured levels.
Measured levels take priority.

2018-325 sartan is expected discrepancy (noted already in the data)- TODO fix. 

```{r}
long_raw %>% select(subject_id, drug_class, level, cohort, has) %>%
  group_by(cohort, subject_id, drug_class, has) %>%
  summarise(has_from_levels = any(!is.na(level)), .groups = "drop") %>%
  filter(has != has_from_levels)
```

This is where manual adherence differs from the computed one.

```{r}
long_for_checks %>% 
    select(cohort, subject_id, drug_class, adherent, adherent_manual) %>%
    filter(adherent_manual != adherent) %>%  distinct()  

```

# Exploratory plots

```{r}
data_wide %>% group_by(subject_id) %>%
  summarise(in2018 = any(cohort == 2018), in2020 = any(cohort == 2020), .groups = "drop") %>%
  group_by(in2018, in2020) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(cohort = case_when(in2018 & in2020 ~ "both",
                            in2018 ~ "only 2018",
                            in2020 ~ "only 2020")) %>%
  select(cohort, count)

```


First let's look at the drug combinations in use:

TODO: upset - by cohort? Or merge (currently, imputing NAs as 0)

```{r}
data_upset <- data_wide %>% 
  mutate(subject_id = paste(subject_id, cohort, sep = "_")) %>%
  select(subject_id, starts_with("has.")) %>%
  mutate(across(starts_with("has."), ~ replace_na(.x, 0L)))
names(data_upset) <- gsub("^has.", "", names(data_upset))
  
upset(as.data.frame(data_upset), sets = names(data_upset)[2:ncol(data_upset)], order.by = "freq", nintersects = NA, nsets = 10)
```

And the overall adherence associated with each drug class (observed proportion - point, 95% credible interval - line, number of users - label):

```{r}
data_long %>% filter(has) %>% group_by(drug_class) %>%
  summarise(yes = sum(adherent == "yes"), no = sum(adherent == "no"),
            proportion = yes / (yes + no), 
            low95 = qbeta(0.025, yes + 1, no + 1),
            high95 = qbeta(0.975, yes + 1, no + 1),
            total = yes + no) %>%
  ggplot(aes(x = drug_class, y = proportion, ymin = low95, ymax = high95, label = total)) + 
    geom_linerange() + geom_point(size = 2) + geom_label(y = 1.1) + expand_limits(y = 1.1) + scale_y_continuous("Proportion adherent") + scale_x_discrete("Drug class") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 1))
```

Below is the number of drugs patients are adherent to (horizontal axis) split by the total number of drugs used (subplots)

```{r}
N_drugs_per_subject <- data_long %>%
  filter(has) %>%
  group_by(subject_id, cohort) %>%
  summarise(N_adherent = sum(has & adherent_int, na.rm = TRUE), N_drugs = sum(has, na.rm = TRUE)) %>%
  group_by(N_drugs, N_adherent) %>%
  summarise(count = n())

crossing(N_adherent = 0:max(N_drugs_per_subject$N_drugs), N_drugs = 1:max(N_drugs_per_subject$N_drugs)) %>% 
  filter(N_adherent <= N_drugs) %>%
  left_join(N_drugs_per_subject,  by = c("N_adherent", "N_drugs")) %>%
  group_by(N_drugs) %>%
  mutate(count = replace_na(count, 0), total = sum(count)) %>%
  group_by(N_drugs, N_adherent, count) %>%
  summarise(
    proportion = count / total, 
            low95 = qbeta(0.025, count + 1, total - count + 1),
            high95 = qbeta(0.975, count + 1, total - count + 1)) %>%
  ggplot(aes(x = N_adherent, y = count)) + 
    geom_line() +
    geom_point(size = 2) +
    facet_wrap(~N_drugs, scales = "free_y", labeller = label_both)
  # ggplot(aes(x = N_adherent, y = proportion, ymin = low95, ymax = high95, label = count)) + 
  #   geom_linerange() + geom_point(size = 2) + geom_label(y = 1.1) + expand_limits(y = 1.1) +
  #   facet_wrap(~N_drugs)
  
  
```

Or to summarise into five adherence categories:

```{r}
data_long_sum <- data_long %>%
  filter(has) %>%
  group_by(subject_id) %>%
  summarise(N_adherent = sum(has & adherent_int, na.rm = TRUE), N_drugs = sum(has, na.rm = TRUE),
            category = case_when(N_adherent == 0 ~ "A - none",
                                 N_adherent == N_drugs ~ "E - all",
                                 N_adherent <= 0.5 * N_drugs ~ "B - half or less",
                                 N_adherent == N_drugs - 1 ~ "D - all but one",
                                 TRUE ~ "C - in between"
                                 )) 

data_long_sum %>%
  group_by(category) %>%
  summarise(n())
```

Same as above, but excluding furosemide

```{r}
data_long_sum_no_fur <- data_long %>%
  filter(has, drug_class != "furosemide") %>%
  group_by(subject_id) %>%
  summarise(N_adherent = sum(has & adherent_int, na.rm = TRUE), N_drugs = sum(has, na.rm = TRUE),
            category = case_when(N_adherent == 0 ~ "A - none",
                                 N_adherent == N_drugs ~ "E - all",
                                 N_adherent <= 0.5 * N_drugs ~ "B - half or less",
                                 N_adherent == N_drugs - 1 ~ "D - all but one",
                                 TRUE ~ "C - in between"
                                 )) 

data_long_sum_no_fur %>%
  group_by(category) %>%
  summarise(n())
```

I.e. most people are adherent to all their medications and very few are non-adherent to multiple medications.

## Adherence by various factors

For continuous measures, we display the measure (here age) on the horizontal axis. Each dot is then a single patient using the drug (either adherent or non-adherent).
The blue line then represents a logistic regression fit with it's associated confidence interval (gray band).

```{r}
plot_adherence_by_continuous(data_long, age)
```

For discrete variables, we show for each category the average adherence (point) and
the associated 95% CI (line). The total number of patients taking the drug falling into each category is shown in the numerical label.

```{r}
plot_adherence_by_discrete(data_long, sex)

```

A bunch of plots for various variables follow:

```{r}


plot_adherence_by_continuous(data_long, BMI)
plot_adherence_by_discrete(data_long, NYHA)
plot_adherence_by_continuous(data_long, systolic_BP)
plot_adherence_by_continuous(data_long, diastolic_BP)
plot_adherence_by_continuous(data_long, EF_numeric)
plot_adherence_by_continuous(data_long, pmin(EF_first_ambulance_numeric, EF_first_contact_numeric, na.rm = TRUE)) + scale_x_continuous("Worst EF ambulance/contact")
plot_adherence_by_continuous(data_long, ekg_freq)
plot_adherence_by_continuous(data_long, lab_Na)
plot_adherence_by_continuous(data_long, lab_Cl)
plot_adherence_by_continuous(data_long, lab_U) + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_K)
plot_adherence_by_continuous(data_long, lab_Kr)  + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_NT_proBNP) + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_GFR) + geom_vline(color = "red", xintercept = 1.55)
```


```{r}
#unique(data_long$VO2_max)
plot_adherence_by_continuous(data_long, as.numeric(VO2_max))

```

## Drugs and their expected metabolic effect

Beta blockers should reduce EKG, pulse. Indeed a mild reduction is visible, but only in the 2020 cohort.
Note in all plots we have "no",  "yes" for adherence and "N/M" (not measured) when the patient is taking the drug, but we couldn't measure adherent and "N/T" when the patient is not taking the drug at all.

```{r}



plot_continuous_by_class_adherence(data_long, "BB", ekg_freq, "EKG frequency")
plot_continuous_by_class_adherence(data_long, "BB", pulse)


```

MRA, ACEi, Sartans and ARNI should increas potassium levels - we see this quite strongly with ARNI, although minor increases are also seen MRA and ACEi. For sartan, we do not observe this (potentially due to very low sample size).

```{r}
plot_continuous_by_class_adherence(data_long, c("MRA", "ACEi", "sartan", "ARNI"), lab_K, "Potassium")

```


Furosemide and other diuretics should decrease potassium, but wo do not observe this for furosemide and have no non-adherent diuretics patient that didn't have .

```{r}
plot_continuous_by_class_adherence(data_long, c("furosemide","other_diuretics"), lab_K, "Potassium")
```

All except statins and digoxine should reduce blood pressure, which we mostly observe:

```{r}
all_bp_lowering <- c("ACEi","sartan","ARNI","furosemide","MRA","BB", "CaB", "other_diuretics")
plot_continuous_by_class_adherence(data_long, all_bp_lowering, 
                                   systolic_BP)
plot_continuous_by_class_adherence(data_long, all_bp_lowering, 
                                   diastolic_BP)

```

## Mortality

```{r}
data_wide %>% group_by(subject_id) %>% summarise(n_alive = length(unique(alive_2021_12_11))) %>%  filter(n_alive > 1)
```


```{r}
data_wide %>% group_by(subject_id, cohort) %>% summarise(death = any(alive_2021_12_11 != "ano")) %>%
  group_by(cohort) %>% summarise(count = n(), sum(death))

```


```{r}
data_wide_sum <- data_wide %>% inner_join(data_long_sum, by = "subject_id")
if(nrow(data_wide_sum) != nrow(data_wide)) {
  stop("Bad join")
}

data_wide_sum %>% group_by(cohort, category) %>% summarise(count = n(), deaths = sum(alive_2021_12_11 != "ano"), mean_alive = mean(alive_2021_12_11 == "ano"))
```


```{r}
data_wide %>% group_by(cohort) %>%
  summarise(count = n(), deaths = sum(alive_2021_12_11 != "ano"), mean_alive = mean(alive_2021_12_11 == "ano"),
            deaths_low = qbeta(0.025, deaths + 1, count - deaths + 1), deaths_high = qbeta(0.975, deaths + 1, count - deaths + 1))
```


## Adherence questionnaire

The questionnaire was:

- Q1: Have you ever forgotten to take your heart failure medication. Orig: "ZapomnÄl jste si nÄkdy vzÃ­t lÃ©ky na srdeÄnÃ­ selhÃ¡nÃ­?"
- Q2: Do you dutifully use your heart failure medication? Orig: "Jste peÄlivÃ½ v uÅ¾Ã­vÃ¡nÃ­ lÃ©kÅ¯ na srdeÄnÃ­ selhÃ¡nÃ­?"
- Q3: When you feel well, do you sometimes skip your heart failure medication? Orig: "KdyÅ¾ se cÃ­tÃ­te dobÅe, vysadÃ­te si nÄkdy lÃ©ky na srdeÄnÃ­ selhÃ¡nÃ­?"
- Q4: Do you sometimes skip your heart failure medication when you feel unwell? Orig: "NÄkdy, kdyÅ¾ se cÃ­tÃ­te Å¡patnÄ, vysadÃ­te si lÃ©ky na srdeÄnÃ­ selhÃ¡nÃ­?"

So in summary affirmitive answer to Q1, Q3 and Q4 should mean less adherence while
affirmitive answer to Q2 should mean more adherence.


Let's plot the answers per question:


For Q1 we see a relatively big portion of affirmitive answers, those however don't appear to be associated with any strong decrease in adherence.


```{r}
plot_adherence_by_discrete(data_long, questionnaire_1) 
```

Q2 appears to be of very limited usefulness as almost all patients respond in the affirmitive. For the drug classes where we have a bit more negative answers (MRA, BB) we see some trend towards more adherence for affirmitive responses, but it is not very convincing.

```{r}
plot_adherence_by_discrete(data_long, questionnaire_2)
```

Questionnaire 3 and 4 are even less useful as only one patient responded in the affirmitive for Q3 and only two for Q4 and thus there is really nothing much to be learned. 

Finally, we can try to combine all the questions into a composite score (coding Q2 as negative, others as positive), so that increased score should mean less adherence. Once again there does not appear to be much going on in the composite score.

```{r}
plot_adherence_by_discrete(data_long %>% mutate(q_total = questionnaire_1 - questionnaire_2 + questionnaire_3 + replace_na(questionnaire_4, 0)), q_total)

```



# Modelling

## Adherence by factors

It turns out that a model incorporating the drug class and some between-subject variability is about as much as we can reliably get from the data and so
we cannot work very usefully with individual factors (but see the Bad Health section below)

```{r}
data_for_model1 <- data_long %>% filter(has, !is.na(adherent_int)) 

if(any(is.na(data_for_model1$adherent_int))) {
  stop("NAs")
}
priors1 <- prior(normal(0,2), class = "sd")
fit1 <- brm(adherent_int ~ (1 | drug_class) + (1 | subject_id) + cohort, family = "bernoulli", data = data_for_model1, prior = priors1, 
            file = paste0(cache_dir, "/fit1"), file_refit = "on_change", refresh = 500)

summary(fit1)
ranef(fit1)$drug_class
```



```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit1)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$cohort)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$drug_class, data_for_model1$cohort))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$drug_class)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$sex)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, data_for_model1$drug_class), freq = FALSE)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = cut(data_for_model1$age, 4))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, cut(data_for_model1$age, 4)))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$NYHA, freq = FALSE)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = replace_na(data_for_model1$EF, "NA"), freq = FALSE)
}
```


TODO:
plot observed adherence vs. fit1 predicted adherence

```{r}
fit_simple <- brm(adherent_int ~ (1 | drug_class) + cohort, family = "bernoulli", data = data_for_model1, prior = priors1, 
            file = paste0(cache_dir, "/fit_simple"), file_refit = "on_change", refresh = 500)

summary(fit_simple)
ranef(fit_simple)$drug_class
```

```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit_simple)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$cohort)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$drug_class, data_for_model1$cohort))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$drug_class)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$sex)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = cut(data_for_model1$age, 4))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, cut(data_for_model1$age, 4)))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$NYHA)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = replace_na(data_for_model1$EF, "NA"))
}
```


```{r}
data_aggregate <- data_long %>% filter(has) %>%
  group_by_at(vars(- all_of(c("drug_class", "has", "adherent", "drug_superclass", "adherent_int")))) %>%
  summarise(N_drugs = sum(has & !is.na(adherent_int)), N_adherent = sum(adherent_int, na.rm = TRUE), 
            prop = N_adherent / N_drugs,
            .groups = "drop") 

if(nrow(data_aggregate) != nrow(data_wide)) {
  stop("Bad processing")
}

if(!identical(sort(unique(data_aggregate$subject_id)), sort(unique(data_wide$subject_id)))) {
  stop("Bad processing")
}

data_aggregate <- data_aggregate %>%
  filter(N_drugs != 0 | N_adherent != 0)
```


```{r}
fit_aggregate_simple <- brm(N_adherent | vint(N_drugs) ~ 1 + cohort, data = data_aggregate, family = beta_binomial2, stanvars = stanvars_beta_binomial2, refresh = 500, file = paste0(cache_dir, "/fit_aggregate_simple"), file_refit = "on_change")

summary(fit_aggregate_simple)
```

```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit_aggregate_simple)
  preds_prop <- sweep(preds, MARGIN = 2, STATS = data_aggregate$N_drugs, FUN = "/")

  ppc_stat_grouped(data_aggregate$prop, yrep = preds_prop, group = data_aggregate$cohort)
  ppc_stat_grouped(data_aggregate$prop, yrep = preds_prop, group = data_aggregate$cohort, stat = sd)

    ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$sex)
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$sex, stat = sd)
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = cut(data_aggregate$age, 4))
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = cut(data_aggregate$age, 4), stat = sd)
  
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$NYHA)
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$NYHA, stat = sd)
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = substr( replace_na(data_aggregate$EF, "NA"),1, 1)) + ggtitle("EF/10")
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = substr( replace_na(data_aggregate$EF, "NA"),1, 1), stat = sd)  + ggtitle("EF/10")
}
```


## Bad health

For the bad health model, we assume that both adherence and some clinical values (
VO2 max, NYHA, EF, NT-proBNP) are affected by the same construct of "bad health" - which is a one-dimensional quantity per subject. I.e. we don't expect a direct effect of say VO2 max on adherence, rather that VO2 max, NYHA, EF, NT-proBNP and adherence share the same unobserved causal factor.

Here is how the 4 clinical parameters correlate:

```{r}
#data_for_model1 %>% group_by(EF) %>% summarise(n())
data_wide %>% select(EF, VO2_max, NYHA, lab_NT_proBNP) %>% mutate(EF = as.integer(factor(EF)) + runif(n(), -0.1,0.1), NYHA = as.integer(factor(NYHA))  + runif(n(), -0.1,0.1), lab_NT_proBNP = log(lab_NT_proBNP)) %>% as.matrix() %>% pairs()
```

```{r}
# data_for_model1 %>% group_by(subject_id) %>%
#   summarise(prop_adherent = sum(adherent_int) /  n()) %>%
#   group_by(prop_adherent) %>%
#   summarise(n())
```

```{r}
repeated <- data_wide %>% 
  group_by(subject_id) %>% filter(n() > 1)

repeated %>% ggplot(aes(x = cohort, y = NYHA, group = subject_id)) + geom_line(position = position_jitter(width = 0.1, height = 0.1), alpha = 0.5)

repeated %>% ggplot(aes(x = cohort, y = EF, group = subject_id)) + geom_line(position = position_jitter(width = 0.1, height = 0.1), alpha = 0.5)

repeated %>% ggplot(aes(x = cohort, y = lab_NT_proBNP, group = subject_id)) + geom_line(alpha = 0.5) + scale_y_log10()
```


We can now fit the model

```{r}
mod_badhealth <- cmdstan_model("badhealth.stan")
```

```{r, results = 'hide'}
data_for_badhealth <- data_for_model1 %>% 
  mutate(measurement_id = paste(subject_id, cohort, sep = "_"))

measurement_id_map <- 1:length(unique(data_for_badhealth$measurement_id))
names(measurement_id_map) <- unique(data_for_badhealth$measurement_id)

patient_data <- data_for_badhealth %>% 
  select(measurement_id,
         cohort,                                                             
         NYHA,
         VO2_max,
         EF,
         lab_NT_proBNP) %>%
  distinct() %>%
  mutate(measurement_id_model = measurement_id_map[measurement_id],
         NYHA = factor(NYHA),
         EF = factor(EF)) %>%
  arrange(measurement_id_model)

data_badhealth_stan <- list(
  N = nrow(data_for_badhealth),
  adherent = data_for_badhealth$adherent_int,
  N_classes = length(unique(data_for_badhealth$drug_class)),
  classes = factor(data_for_badhealth$drug_class),
  N_measurements = length(measurement_id_map),
  measurement = measurement_id_map[as.character(data_for_badhealth$measurement_id)],
  N_NYHA = length(levels(patient_data$NYHA)),
  NYHA = patient_data$NYHA,
  VO2_max_missing = is.na(patient_data$VO2_max),
  VO2_max = replace_na(patient_data$VO2_max, 0),
  NT_proBNP_missing = is.na(patient_data$lab_NT_proBNP),
  NT_proBNP = replace_na(patient_data$lab_NT_proBNP, 0),
  N_EF = length(levels(patient_data$EF)),
  EF_missing = is.na(patient_data$EF),
  EF = replace_na(as.integer(patient_data$EF), 0),
  cohort = patient_data$cohort == "2020"
  
)

cache_file <- file.path(cache_dir, paste0("fit_badhealth_", rlang::hash(data_badhealth_stan), "_", rlang::hash(mod_badhealth$code())))
if(file.exists(cache_file)) {
  fit_badhealth <- readRDS(cache_file)
} else {
  fit_badhealth <- mod_badhealth$sample(data = data_badhealth_stan, refresh = 500)
  fit_badhealth$save_output_files(dir = cache_dir)
  saveRDS(fit_badhealth, file = cache_file)
}
  
```

Summarising the most important aspect of the fits:

```{r}
fit_badhealth$summary(variables = c("badhealth_slope", "nyha_thres", "VO2_max_slope", "NT_proBNP_slope", "EF_thres", "cohort_diff")) %>% knitr::kable()
```

we are primarily interested in the "badhealth_slope" variable, which is the association between bad health and adherence. We see that the 90% credible interval  is clearly positive, i.e. worse health is associated with increased adherence. Other parameters show the link between bad health and the other variables.

The value of the bad health hidden variable can be interpreted e.g by it's association to NYHA levels - the "nyha_thres" variables are the thresholds for NYHA levels (we observe 6 NYHA levels: `r paste0(levels(patient_data$NYHA), collapse = ", ")`). So bad health < -1.9 would be most often (but not always) associated with NYHA 1 while bad health between 1.7 and 4.2 would be associated with NYHA 3.


TODO: maybe show difference in adherence from "best" to "worst" patient?

```{r}
worst_health_model_ids <- fit_badhealth$summary(variables = "badhealth") %>% arrange(desc(q5)) %>% slice_head(n = 5) %>% pull(variable) %>%
  gsub("badhealth\\[|\\]", "", .)
worst_health_measurement_ids <- sort(names(measurement_id_map[measurement_id_map %in% worst_health_model_ids]) )
```

The model assumes the worst health is observed in patients ID `r worst_health_measurement_ids`.

```{r}
if(run_pp_checks) {
  badhealth_rvars <- posterior::as_draws_rvars(fit_badhealth$draws())
  linpred_adherent <- badhealth_rvars$adherent_intercept + badhealth_rvars$class_intercept[data_badhealth_stan$classes] + 
    badhealth_rvars$badhealth_slope * badhealth_rvars$badhealth[data_badhealth_stan$measurement] 
  
  epred_adherent <- posterior::rdo(plogis(linpred_adherent))
  
  pred_adherent <- posterior::draws_of(posterior::rvar_rng(rbinom, n = data_badhealth_stan$N, prob = epred_adherent, size = 1))
}
```

```{r}
if(run_pp_checks) {
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = data_for_badhealth$sex)
  
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = cut(data_for_badhealth$age, 4))
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = data_for_badhealth$NYHA)
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = replace_na(as.character(cut(data_for_badhealth$VO2_max, 4)), "NA"))
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = cut(log(replace_na(data_for_badhealth$lab_NT_proBNP, 0.0001)), 4))
  
  
  
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = replace_na(substr( data_for_badhealth$EF,1, 1), "NA")) + ggtitle("EF/10")
}
```

```{r}
if(run_pp_checks) {
  linpred_NT_proBNP <- badhealth_rvars$NT_proBNP_intercept + badhealth_rvars$NT_proBNP_slope * badhealth_rvars$badhealth
  pred_NT_proBNP <- posterior::draws_of(posterior::rvar_rng(rlnorm, n = data_badhealth_stan$N_measurements,  linpred_NT_proBNP, badhealth_rvars$NT_proBNP_sd))
  
  ppc_dens_overlay(log(data_badhealth_stan$NT_proBNP), log(pred_NT_proBNP[sample(1:4000, 50),]))
  ppc_dens_overlay_grouped(log(data_badhealth_stan$NT_proBNP), log(pred_NT_proBNP[sample(1:4000, 50),]), group = fct_collapse(patient_data$NYHA, "3-4" = c("3", "3-4")))
  
  badhealth_noised <- posterior::rvar_rng(rlogis, n = data_badhealth_stan$N_measurements, location = badhealth_rvars$badhealth)
  pred_NYHA <- 1
  for(i in 1:dim(badhealth_rvars$nyha_thres)) {
    pred_NYHA <- pred_NYHA + (badhealth_noised > badhealth_rvars$nyha_thres[i])
  }
  
  pred_NYHA <- posterior::draws_of(pred_NYHA)
  obs_NYHA <- as.integer(data_badhealth_stan$NYHA)
  
  ppc_bars(obs_NYHA, pred_NYHA)
  ppc_bars_grouped(obs_NYHA, pred_NYHA, group = cut(log(patient_data$lab_NT_proBNP), 4))
}
```

```{r}
if(run_pp_checks) {
  pred_EF <- 1
  for(i in 1:dim(badhealth_rvars$EF_thres)) {
    pred_EF <- pred_EF + (badhealth_noised > badhealth_rvars$EF_thres[i])
  }
  
  obs_EF <- as.integer(data_badhealth_stan$EF)
  pred_EF <- posterior::draws_of(pred_EF)[,!data_badhealth_stan$EF_missing]
  obs_EF <- obs_EF[!data_badhealth_stan$EF_missing]
  
  ppc_bars(obs_EF, pred_EF)
  ppc_bars_grouped(obs_EF, pred_EF, group = cut(log(patient_data$lab_NT_proBNP[!data_badhealth_stan$EF_missing]), 3))
}
```


## Mortality



## Adherence questionnaire

Q1, Q3, Q4 - affirmitive anwer -> less adherence
Q2 - affirmitive answer -> more adherence

First, let's try a model excluding Q3 and Q4

```{r}
data_questionnaire <- data_for_model1 %>% 
  filter(cohort == "2020") %>% 
  mutate(questionnaire_2_r = 1 - questionnaire_2, questionnaire_4 = replace_na(questionnaire_4, 0))

priors_questionnaire <- c(priors1, prior(normal(0,2), class = "b"))

formula_questionnaire <- brmsformula(adherent_int ~ (1 | drug_class) + questionnaire_1 + questionnaire_2, family = "bernoulli")

fit_questionnaire <- brm(formula_questionnaire, data = data_questionnaire, prior = priors_questionnaire, 
            file = paste0(cache_dir, "/fit_questionnaire"), file_refit = "on_change", refresh = 500)

summary(fit_questionnaire)

```

```{r}
questionnaire_rvars <- posterior::as_draws_rvars(fit_questionnaire)
prob_q1 <- mean(questionnaire_rvars$b_questionnaire_1 < 0 )
prob_q2 <- mean(questionnaire_rvars$b_questionnaire_2 > 0 )
prob_both <- mean(questionnaire_rvars$b_questionnaire_1 < 0 & questionnaire_rvars$b_questionnaire_2 > 0)

prob_neither <- mean(questionnaire_rvars$b_questionnaire_1 > 0 & questionnaire_rvars$b_questionnaire_2 < 0)

```

We are left with substantial uncertainty about even the sign (let alone magnitude) of the association between Q1, Q2 and adherence. Our posterior probability that the association is positive for Q1 is `r scales::percent(prob_q1)` (as one would expect). For Q2 the association is to be expected to be negative and our posterior probability that it actually is negative is `r scales::percent(prob_q2)`. The probability that both associations are in the expected direction is `r scales::percent(prob_both)`, but we find it unlikely that neither would go in the expected direction (posterior probability is `r scales::percent(prob_neither, accuracy = 2)`)

Another way to look at the same result is to predict the expected absolute difference in adherence for a group of patients that responded to both questions by indicating high adherence and a group of patients responded to both questions by indicating low adherence. While our model assumes the same relative effect on the log odds scale for all drugs, the absolute effect can differ between drugs due to their differing baseline adherence. Here's a graphical summary showing the posterior distribution and the central 50% and 95% credible intervals:

```{r}
q_pred <- crossing(data.frame(drug_class = c("BB", "ARNI", "statin", "furosemide")),
                   data.frame(questionnaire_1 = c(0, 1), questionnaire_2 = c(1,0), label = factor(c(1,2), levels = 2:1, labels = c("Low", "High")))) %>% tidybayes::add_epred_draws(fit_questionnaire) %>%
  group_by(drug_class, .draw) %>%
  mutate(epred_diff = .epred[label == "High"] - .epred[label == "Low"]) %>%
  ungroup()

q_pred %>%  
  ggplot(aes(x = epred_diff, y = drug_class)) + 
  geom_vline(xintercept = 0, color = "blue") +
  stat_halfeye() + 
  scale_x_continuous("Absolute adherence difference", labels = scales::percent) +
  scale_y_discrete("Drug class")

```

Numerically, the same results are:

```{r}
q_pred %>% group_by(drug_class) %>%
  summarise(`Expected adherence difference` = scales::percent(mean(epred_diff)),
            `95% CI` = paste0("(",scales::percent(quantile(epred_diff, prob = 0.025)), "; ", scales::percent(quantile(epred_diff, prob = 0.975)), ")"))
            
```

So we have substantial uncertainty about the association of the questions with adherence outcome.




```{r}
# The results don't really change with an aggreagte model, commenting out

# fit_questionnaire_aggregate <- brm(N_adherent | vint(N_drugs) ~ 1 + questionnaire_1 + questionnaire_2, 
#                                    data = data_aggregate, 
#                                    family = beta_binomial2, 
#                                    stanvars = stanvars_beta_binomial2, refresh = 500,
#                                    prior = prior(normal(0,2), class = "b"),
#                                    file = paste0(cache_dir, "/fit_questionnaire_aggregate"), file_refit = "on_change")
# 
# summary(fit_questionnaire_aggregate)
```


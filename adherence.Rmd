---
title: "Adherence"
output: 
  bookdown::word_document2: 
    toc: false
    number_sections: false
    reference_docx: "output_template.docx"
    df_print: kable
date: "Version: `r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, message=FALSE, echo = FALSE, results='hide', warning = FALSE}
library(tidyverse)
library(readxl)
library(UpSetR)
library(brms)
library(cmdstanr)
library(bayesplot)
library(tidybayes)
library(ggdist)
library(gtsummary)
library(flextable)

knitr::opts_chunk$set(echo=FALSE, fig.width = 8, fig.height = 5, cache = TRUE)

document_output <- isTRUE(getOption('knitr.in.progress'))

if(document_output) {
  table_format <- function(x, caption = NULL, align = NULL) { 
    knitr::kable(x, caption = caption, align = align) 
  }
} else {
  table_format <- function(x, caption = NULL, align = NULL) { x }
}


options(mc.cores = 4, brms.backend = "cmdstanr", dplyr.summarise.inform = FALSE)
cache_dir <- here::here("stored_fits")
if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}

theme_set(cowplot::theme_cowplot())

run_pp_checks <- FALSE

devtools::load_all()

```


```{r load-data}
source(here::here("data_into_session.R"))
```


Following subjects have discrepancy between the "Má XX" column and measured levels.
Measured levels take priority.

2018-325 sartan is expected discrepancy (noted already in the data)- TODO fix. 

```{r}
long_raw %>% select(subject_id, drug_class, level, cohort, has) %>%
  group_by(cohort, subject_id, drug_class, has) %>%
  summarise(has_from_levels = any(!is.na(level)), .groups = "drop") %>%
  filter(has != has_from_levels)
```

This is where manual adherence differs from the computed one.

```{r}
long_for_checks %>% 
    select(cohort, subject_id, drug_class, adherent, adherent_manual) %>%
    filter(adherent_manual != adherent) %>%  distinct()  

```


# Summary statistics

Table 1 - we count patients from both cohorts twice here (otherwise we'd need to figure out how to pick just one lab, NYHA, age, ... for repeated patients - e.g. taking the later measurement only would be an option)

TODO unsure how to get "Lowest LVEF during previous follow up [%]" should that be one of "První EFLK v ambulanci pro srdeční selhání" or "Úplně původní EFLK (%) při prvním kontaktu s nemocnicí"?
"

```{r, message=FALSE}
# data_wide %>%
#   mutate(BMI2 = weight /(height / 100) ^ 2, BMI_diff = BMI2 - BMI) %>%
#   pull(BMI_diff) %>% table()

data_table1 <- data_wide %>% 
  mutate(BMI = weight /(height / 100) ^ 2, deceased_2021_12_11 = !alive_2021_12_11) %>%
  select(
    subject_id,
  sex, age, weight, height, BMI, ekg_freq, diabetes, pulse, systolic_BP, diastolic_BP, NYHA, EF_numeric, starts_with("lab_"), starts_with("has."), cohort,
  deceased_2021_12_11
) 

tbl1_stats <- list(all_continuous() ~ "{mean} (±{sd})")
tbl_summary(data_table1, statistic = tbl1_stats, include = -subject_id)
```


## Summary by cohorts. 

P-values for tests are: Wilcoxon test for continous, Chi-squared test for all categorical.

```{r, message=FALSE}
tbl1_test <- list(all_categorical() ~ "chisq.test")
tbl_summary(data_table1, by = cohort, statistic = tbl1_stats, include = -subject_id) %>% add_p(test = tbl1_test)
```




Overlap between cohorts

```{r}
data_wide %>% group_by(subject_id) %>% 
  summarise(cohort_ = if_else(n() == 2, "both", paste(cohort, collapse = ","))) %>%
  group_by(cohort_) %>% tally()
```

## Adherence categories

```{r}
stopifnot(all(!is.na(data_long$adherent)))

data_adherent_sum_fur <- data_long %>%
  group_by(subject_id, cohort) %>%
  summarise(N_adherent = sum(adherent == "yes"), N_nonadherent = sum(adherent == "no"), N_drugs = N_adherent + N_nonadherent)


N_no_drugs <- sum(data_adherent_sum_fur$N_drugs == 0)
stopifnot(N_no_drugs == 1)

subject_id_no_drugs <- data_adherent_sum_fur %>% filter(N_drugs == 0) %>% pull(subject_id)

stopifnot(sum(data_wide$subject_id == subject_id_no_drugs) == 1)

```

Added 2023-10-27:

There was a single patient that had no drugs measured - we exclude them for computing adherence.

We define five "fine" categories as:

- None: Adherent to 0 drugs (regardless of number of drugs measured, i.e. will include patients with just 1 drug evaluated, to which they are not adherent)
- All: Patients adherent to all drugs we measured
- Half or less: Patients taking at least 2 drugs we measured and adherent to some, but at most half of the drugs we measured (For patients taking 2 or 3 drugs we measured, this will include only those adherent to exactly one of them)
- All but one: Patients taking at least 3 drugs we measured and non-adherent to only one of them
- In between: All the other patients, i.e. patients adherent to more than half of the drugs we measured, but non-adherent to more than one

For most of the comparisons, we collapse all the categories to just two coarse categories "Fully adherent" (corresponds to "All") and "Non-adherent" (collapsing all the other categories).

First, let's show all drugs (incuding furosemide):

```{r}
data_adherent_cat_fur <- data_adherent_sum_fur %>%
  filter(N_drugs > 0) %>%
  mutate(category_with_fur = case_when(N_drugs == 0 ~ "0 drugs",
                       N_adherent == 0 ~ "A - none",
                       N_adherent == N_drugs ~ "E - all",
                       N_adherent <= 0.5 * N_drugs ~ "B - half or less",
                       N_adherent == N_drugs - 1 ~ "D - all but one",
                       TRUE ~ "C - in between"
                       ),
  category_bin_with_fur = if_else(N_adherent == N_drugs, "Fully adhererent", "Non-adherent")) 

data_adherent_cat_fur %>%
  group_by(category_with_fur) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))

data_adherent_cat_fur %>%
  group_by(category_bin_with_fur) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))
```

Same as above, but excluding furosemide, but including drugs only measured in the 2020 cohort

```{r}
data_adherent_cat_non_shared <- data_long %>%
  filter(drug_class != "furosemide") %>%
  group_by(subject_id, cohort) %>%
  summarise(N_adherent = sum(adherent == "yes"), N_nonadherent = sum(adherent == "no"), N_drugs = N_adherent + N_nonadherent,
            category = case_when(N_drugs == 0 ~ "0 drugs",
                                 N_adherent == 0 ~ "A - none",
                                 N_adherent == N_drugs ~ "E - all",
                                 N_adherent <= 0.5 * N_drugs ~ "B - half or less",
                                 N_adherent == N_drugs - 1 ~ "D - all but one",
                                 TRUE ~ "C - in between"
                                 ),
            category_bin = if_else(N_adherent == N_drugs, "Fully adhererent", "Non-adherent"),
            .groups = "drop") %>%
  filter(N_drugs > 0)

data_adherent_cat_non_shared %>%
  group_by(category) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))

data_adherent_cat_non_shared %>%
  filter(N_drugs > 0) %>%
  group_by(category_bin) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))
```

I.e. most people are adherent to all their medications and very few are non-adherent to multiple medications.

Added 2023-10-27: We check how much do those numbers differ between cohorts:

```{r}
data_adherent_cat_non_shared %>%
  filter(N_drugs > 0) %>%
  group_by(cohort, category) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(cohort) %>%
  mutate(percent = scales::percent(N / sum(N))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "percent"))


data_adherent_cat_non_shared %>%
  filter(N_drugs > 0) %>%
  group_by(cohort, category_bin) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(cohort) %>%
  mutate(percent = scales::percent(N / sum(N))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "percent"))
```

Indeed it appears that the 2020 cohort had less adherence, which is primarily driven by the increase in the "all but one" category (i.e. people taking more than 2 drugs that are non-adherent to a single drug). A potential explanation is that this increase is due to the longer list of drugs tested in the 2020 cohort.

To check this, we look just at the "all but one" category and see the drug they were not adherent to:

```{r}
id_cohort_all_but_one <- data_adherent_cat_non_shared %>% 
  filter(category == "D - all but one") %>%
  mutate(id_cohort = paste0(subject_id, "_", cohort)) %>%
  pull(id_cohort)

all_but_one_nonadherent <- data_long %>% 
  filter(paste0(subject_id, "_", cohort) %in% id_cohort_all_but_one, has & !adherent_int, drug_class != "furosemide")

stopifnot(length(
  setdiff(id_cohort_all_but_one, paste0(all_but_one_nonadherent$subject_id, "_", all_but_one_nonadherent$cohort)))
  == 0)

stopifnot(nrow(all_but_one_nonadherent) == length(id_cohort_all_but_one))

all_but_one_nonadherent %>%
  group_by(cohort, drug_class) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(cohort) %>%
  mutate(percent = scales::percent(N / sum(N))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "percent")) %>%
  rename(`The only drug class not adhered to` = drug_class)
```

So we see that most of the drugs not adhered to were the drugs we measured in both cohorts. We can also look specifically for adherence to drugs that were measured in both cohorts:

```{r}
data_long %>% filter(!is.na(adherent_int)) %>%
  group_by(drug_class, cohort) %>%
  summarise(N = n(), adherence = scales::percent(mean(adherent_int))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "adherence")) %>%
  filter(!is.na(adherence_2018))
```


The adherence is lower in 2020 for all of those, so presumably, this reflects a genuine difference in overall adherence between cohorts.


### Only drugs in both cohorts

Added 2023-10-29

```{r}
both_cohorts_RAAS <- c("ARNI", "ACEi","sartan")
both_cohorts_other <- c("BB", "MRA")
both_cohorts_drugs <- c(both_cohorts_RAAS, both_cohorts_other)
```


For the main focus on adherence categories we'll limit the look to drugs classes measured in both cohorts, i.e. `r paste0(both_cohorts_other, collapse = ", ")`  and RAAS blockers (`r paste0(both_cohorts_RAAS, collapse = ", ")`).

```{r}
data_adherent_cat_with_zero <- data_long %>%
  filter(drug_class != "furosemide", drug_class %in% both_cohorts_drugs) %>%
  group_by(subject_id, cohort) %>%
  summarise(N_adherent = sum(adherent == "yes"), N_nonadherent = sum(adherent == "no"), N_drugs = N_adherent + N_nonadherent,
            category = case_when(N_drugs == 0 ~ "0 drugs",
                                 N_adherent == 0 ~ "A - none",
                                 N_adherent == N_drugs ~ "E - all",
                                 N_adherent <= 0.5 * N_drugs ~ "B - half or less",
                                 N_adherent == N_drugs - 1 ~ "D - all but one",
                                 TRUE ~ "C - in between"
                                 ),
            category_bin = if_else(N_adherent == N_drugs, "Fully adhererent", "Non-adherent"),
            .groups = "drop") 

N_zero_both <- sum(data_adherent_cat_with_zero$N_drugs == 0)

stopifnot(N_zero_both == 1)
    
data_adherent_cat <- data_adherent_cat_with_zero %>%
  filter(N_drugs > 0)

data_adherent_cat %>%
  group_by(category) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))

data_adherent_cat %>%
  filter(N_drugs > 0) %>%
  group_by(category_bin) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(percent = scales::percent(N / sum(N)))
```

As noted above, this still leads to noticeable differences between cohorts:

```{r}
adherent_cat_by_cohort <- data_adherent_cat %>%
  filter(N_drugs > 0) %>%
  group_by(cohort, category) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(cohort) %>%
  mutate(percent = scales::percent(N / sum(N))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "percent"))

adherent_cat_by_cohort

set.seed(5682233)
chisq_adherent_cat_by_cohort <- adherent_cat_by_cohort %>% select(starts_with("N_")) %>% as.matrix() %>% chisq.test(simulate.p.value = TRUE,B = 10000)

adherent_cat_bin_by_cohort <- data_adherent_cat %>%
  filter(N_drugs > 0) %>%
  group_by(cohort, category_bin) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(cohort) %>%
  mutate(percent = scales::percent(N / sum(N))) %>%
  pivot_wider(names_from = "cohort", values_from = c("N", "percent"))

adherent_cat_bin_by_cohort

chisq_adherent_cat_bin_by_cohort <- adherent_cat_bin_by_cohort %>% select(starts_with("N_")) %>% as.matrix() %>% chisq.test()

p_text <- function(p, p_digits = 2) {
  if(p < 0.001) {
    "p < 0.001"
  } else if(p < 0.01) {
    "p < 0.01"
  } else {
    paste0("p = ", round(p, p_digits))  
  }
}


```


The differences are statistically significant with Chi-squared p-values of `r p_text(chisq_adherent_cat_by_cohort$p.value)` and `r p_text(chisq_adherent_cat_bin_by_cohort$p.value)` for the fine categories and for the binary categorization respectively.

Comparison of clinical and laboratory parameters of adherent and non-adherent patients (only drugs measured in both cohorts, note a single excluded patient who had no drugs measured):

```{r, message=FALSE}
data_table_comparison <- data_table1 %>%
  filter(!(subject_id %in% subject_id_no_drugs)) %>%
  inner_join(data_adherent_cat, by = c("subject_id", "cohort"), relationship = "one-to-one", unmatched = "error") %>%
  select(-N_adherent, -N_drugs, -category, -N_nonadherent, -subject_id, -ekg_freq, )

pvalue_fun_BH <- function(ps)  {
  style_pvalue(p.adjust(ps, method = "BH"))
}

tbl_summary(data_table_comparison, by = category_bin, statistic = tbl1_stats)  %>% add_p(test = tbl1_test, pvalue_fun = pvalue_fun_BH) 
```



## Re-enrolled patients

```{r}
re_enrolled_summary <- data_long %>% 
  filter(!is.na(adherent_int)) %>%
  group_by(subject_id, drug_class) %>%
  filter(n() > 1) %>%
  summarise(adherence_change = 
              case_when(length(unique(adherent_int)) == 1 ~ "identical",
                        adherent_int[cohort == "2018"] == 1 ~ "become non-adherent",
                        adherent_int[cohort == "2018"] == 0 ~ "become adherent")) %>%
  group_by(drug_class, adherence_change) %>% 
  tally()

```



# Exploratory plots

```{r}
data_wide %>% group_by(subject_id) %>%
  summarise(in2018 = any(cohort == 2018), in2020 = any(cohort == 2020), .groups = "drop") %>%
  group_by(in2018, in2020) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(cohort = case_when(in2018 & in2020 ~ "both",
                            in2018 ~ "only 2018",
                            in2020 ~ "only 2020")) %>%
  select(cohort, count)

```


First let's look at the drug combinations in use, separately in both cohorts:


```{r, fig.width = 8}
for(coh in unique(data_wide$cohort)) {
  data_upset <- data_wide %>% 
    filter(cohort == coh) %>%
    mutate(subject_id = paste(subject_id, cohort, sep = "_")) %>%
    select(subject_id, starts_with("has.")) %>%
    mutate(across(starts_with("has."), ~ replace_na(.x, 0L)))
  names(data_upset) <- gsub("^has.", "", names(data_upset))
  
  sets_all <- names(data_upset)[2:ncol(data_upset)]
  sets_present_indices <- (data_upset[,sets_all] %>% as.matrix() %>% colSums()) > 0
  sets_to_show <- sets_all[sets_present_indices]
  
  upset(as.data.frame(data_upset), sets = sets_to_show, order.by = "freq", nintersects = NA, nsets = 10) %>% print()
  grid::grid.text(paste0("Drug combinations ", coh),x = 0.65, y=0.95, gp=grid::gpar(fontsize=20))
}
```

And the overall adherence associated with each drug class (observed proportion - point, 95% credible interval - line, number of users - label):

```{r}
data_long %>% filter(has) %>% group_by(drug_class) %>%
  summarise(yes = sum(adherent == "yes"), no = sum(adherent == "no"),
            proportion = yes / (yes + no), 
            low95 = qbeta(0.025, yes + 1, no + 1),
            high95 = qbeta(0.975, yes + 1, no + 1),
            total = yes + no) %>%
  ggplot(aes(x = drug_class, y = proportion, ymin = low95, ymax = high95, label = total)) + 
    geom_linerange() + geom_point(size = 2) + geom_label(y = 1.1) + expand_limits(y = 1.1) + scale_y_continuous("Proportion adherent") + scale_x_discrete("Drug class") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 1))
```

Below is the number of drugs patients are adherent to (horizontal axis) split by the total number of drugs used (subplots)

```{r}
N_drugs_per_subject <- data_long %>%
  filter(has) %>%
  group_by(subject_id, cohort) %>%
  summarise(N_adherent = sum(has & adherent_int, na.rm = TRUE), N_drugs = sum(has, na.rm = TRUE)) %>%
  group_by(N_drugs, N_adherent) %>%
  summarise(count = n())

crossing(N_adherent = 0:max(N_drugs_per_subject$N_drugs), N_drugs = 1:max(N_drugs_per_subject$N_drugs)) %>% 
  filter(N_adherent <= N_drugs) %>%
  left_join(N_drugs_per_subject,  by = c("N_adherent", "N_drugs")) %>%
  group_by(N_drugs) %>%
  mutate(count = replace_na(count, 0), total = sum(count)) %>%
  group_by(N_drugs, N_adherent, count) %>%
  summarise(
    proportion = count / total, 
            low95 = qbeta(0.025, count + 1, total - count + 1),
            high95 = qbeta(0.975, count + 1, total - count + 1)) %>%
  ggplot(aes(x = N_adherent, y = count)) + 
    geom_line() +
    geom_point(size = 2) +
    facet_wrap(~N_drugs, scales = "free_y", labeller = label_both)
  # ggplot(aes(x = N_adherent, y = proportion, ymin = low95, ymax = high95, label = count)) + 
  #   geom_linerange() + geom_point(size = 2) + geom_label(y = 1.1) + expand_limits(y = 1.1) +
  #   facet_wrap(~N_drugs)
  
  
```



## Adherence by various factors

For continuous measures, we display the measure (here age) on the horizontal axis. Each dot is then a single patient using the drug (either adherent or non-adherent).
The blue line then represents a logistic regression fit with it's associated confidence interval (gray band).

```{r}
plot_adherence_by_continuous(data_long, age)
```

For discrete variables, we show for each category the average adherence (point) and
the associated 95% CI (line). The total number of patients taking the drug falling into each category is shown in the numerical label.

```{r}
plot_adherence_by_discrete(data_long, sex)
```

A bunch of plots for various variables follow:

```{r}


plot_adherence_by_continuous(data_long, BMI)
plot_adherence_by_discrete(data_long, NYHA)
plot_adherence_by_continuous(data_long, systolic_BP)
plot_adherence_by_continuous(data_long, diastolic_BP)
plot_adherence_by_continuous(data_long, EF_numeric)
plot_adherence_by_continuous(data_long, pmin(EF_first_ambulance_numeric, EF_first_contact_numeric, na.rm = TRUE)) + scale_x_continuous("Worst EF ambulance/contact")
plot_adherence_by_continuous(data_long, ekg_freq)
plot_adherence_by_continuous(data_long, lab_Na)
plot_adherence_by_continuous(data_long, lab_Cl)
plot_adherence_by_continuous(data_long, lab_U) + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_K)
plot_adherence_by_continuous(data_long, lab_Kr)  + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_NT_proBNP) + scale_x_log10()
plot_adherence_by_continuous(data_long, lab_GFR) + geom_vline(color = "red", xintercept = 1.55)
```


```{r}
#unique(data_long$VO2_max)
plot_adherence_by_continuous(data_long, as.numeric(VO2_max))

```

Added 2023-10-27: diabetes:

```{r}
plot_adherence_by_discrete(data_long, diabetes)
```


## Drugs and their expected metabolic effect

Beta blockers should reduce EKG, pulse. Indeed a mild reduction is visible, but only in the 2020 cohort.
Note in all plots we have "no",  "yes" for adherence and "N/M" (not measured) when the patient is taking the drug, but we couldn't measure adherent and "N/T" when the patient is not taking the drug at all.

```{r}



plot_continuous_by_class_adherence(data_long, "BB", ekg_freq, "EKG frequency")
plot_continuous_by_class_adherence(data_long, "BB", pulse)


```

MRA, ACEi, Sartans and ARNI should increas potassium levels - we see this quite strongly with ARNI, although minor increases are also seen MRA and ACEi. For sartan, we do not observe this (potentially due to very low sample size).

```{r}
plot_continuous_by_class_adherence(data_long, c("MRA", "ACEi", "sartan", "ARNI"), lab_K, "Potassium")

```


Furosemide and other diuretics should decrease potassium, but wo do not observe this for furosemide and have no non-adherent diuretics patient that didn't have .

```{r}
plot_continuous_by_class_adherence(data_long, c("furosemide","other_diuretics"), lab_K, "Potassium")
```

All except statins and digoxine should reduce blood pressure, which we mostly observe:

```{r}
all_bp_lowering <- c("ACEi","sartan","ARNI","furosemide","MRA","BB", "CaB", "other_diuretics")
plot_continuous_by_class_adherence(data_long, all_bp_lowering, 
                                   systolic_BP)
plot_continuous_by_class_adherence(data_long, all_bp_lowering, 
                                   diastolic_BP)

```

## Adherence questionnaire

The questionnaire was:

- Q1: Have you ever forgotten to take your heart failure medication. Orig: "Zapomněl jste si někdy vzít léky na srdeční selhání?"
- Q2: Do you dutifully use your heart failure medication? Orig: "Jste pečlivý v užívání léků na srdeční selhání?"
- Q3: When you feel well, do you sometimes skip your heart failure medication? Orig: "Když se cítíte dobře, vysadíte si někdy léky na srdeční selhání?"
- Q4: Do you sometimes skip your heart failure medication when you feel unwell? Orig: "Někdy, když se cítíte špatně, vysadíte si léky na srdeční selhání?"

So in summary affirmitive answer to Q1, Q3 and Q4 should mean less adherence while
affirmitive answer to Q2 should mean more adherence.


Let's plot the answers per question:


For Q1 we see a relatively big portion of affirmitive answers, those however don't appear to be associated with any strong decrease in adherence.


```{r}
plot_adherence_by_discrete(data_long, questionnaire_1) 
```

Q2 appears to be of very limited usefulness as almost all patients respond in the affirmitive. For the drug classes where we have a bit more negative answers (MRA, BB) we see some trend towards more adherence for affirmitive responses, but it is not very convincing.

```{r}
plot_adherence_by_discrete(data_long, questionnaire_2)
```

Questionnaire 3 and 4 are even less useful as only one patient responded in the affirmitive for Q3 and only two for Q4 and thus there is really nothing much to be learned. 

Finally, we can try to combine all the questions into a composite score (coding Q2 as negative, others as positive), so that increased score should mean less adherence. Once again there does not appear to be much going on in the composite score.

```{r}
plot_adherence_by_discrete(data_long %>% mutate(q_total = questionnaire_1 - questionnaire_2 + questionnaire_3 + replace_na(questionnaire_4, 0)), q_total)

```


# Modelling

For modelling, we ignore furosemide and other diuretics.

## Adherence by factors

It turns out that a model incorporating the drug class and some between-subject variability is about as much as we can reliably get from the data and so
we cannot work very usefully with individual factors (but see the Bad Health section below)

```{r}
data_for_model1 <- data_long %>% filter(has, !is.na(adherent_int),  !(drug_class %in% c("furosemide", "other_diuretics"))) 

if(any(is.na(data_for_model1$adherent_int))) {
  stop("NAs")
}
priors1 <- prior(normal(0,2), class = "sd")
fit1 <- brm(adherent_int ~ (1 | drug_class) + (1 | subject_id) + cohort, family = "bernoulli", data = data_for_model1, prior = priors1, 
            file = paste0(cache_dir, "/fit1"), file_refit = "on_change", refresh = 500)

summary(fit1)
ranef(fit1)$drug_class
```



```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit1)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$cohort)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$drug_class, data_for_model1$cohort))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$drug_class)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$sex)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, data_for_model1$drug_class), freq = FALSE)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = cut(data_for_model1$age, 4))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, cut(data_for_model1$age, 4)))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$NYHA, freq = FALSE)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = replace_na(data_for_model1$EF, "NA"), freq = FALSE)
}
```


```{r}
data_for_model1_both_cohorts <- data_for_model1 %>% filter(drug_class %in% both_cohorts_drugs) 

fit1_both_cohorts <- brm(adherent_int ~ (1 | drug_class) + (1 | subject_id) + cohort, family = "bernoulli", data = data_for_model1_both_cohorts, prior = priors1, 
            file = paste0(cache_dir, "/fit1_both_cohorts"), file_refit = "on_change", refresh = 500, control = list(adapt_delta = 0.99))

summary(fit1_both_cohorts)
ranef(fit1_both_cohorts)$drug_class
```

TODO:
plot observed adherence vs. fit1 predicted adherence

```{r}
fit_simple <- brm(adherent_int ~ (1 | drug_class) + cohort, family = "bernoulli", data = data_for_model1, prior = priors1, 
            file = paste0(cache_dir, "/fit_simple"), file_refit = "on_change", refresh = 500)

summary(fit_simple)
ranef(fit_simple)$drug_class
```

```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit_simple)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$cohort)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$drug_class, data_for_model1$cohort))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$drug_class)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$sex)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = cut(data_for_model1$age, 4))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = interaction(data_for_model1$sex, cut(data_for_model1$age, 4)))
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = data_for_model1$NYHA)
  ppc_bars_grouped(data_for_model1$adherent_int, yrep = preds, group = replace_na(data_for_model1$EF, "NA"))
}
```

```{r}
fit_simple_both_cohorts <- brm(adherent_int ~ (1 | drug_class) + cohort, family = "bernoulli", data = data_for_model1_both_cohorts, prior = priors1, 
            file = paste0(cache_dir, "/fit_simple_both_cohorts"), file_refit = "on_change", refresh = 500, control = list(adapt_delta = 0.99))

summary(fit_simple_both_cohorts)
ranef(fit_simple_both_cohorts)$drug_class
```


```{r}
data_aggregate <- data_long %>% filter(has) %>%
  group_by_at(vars(- all_of(c("drug_class", "has", "adherent", "drug_superclass", "adherent_int")))) %>%
  summarise(N_drugs = sum(has & !is.na(adherent_int)), N_adherent = sum(adherent_int, na.rm = TRUE), 
            prop = N_adherent / N_drugs,
            .groups = "drop") 

if(nrow(data_aggregate) != nrow(data_wide)) {
  stop("Bad processing")
}

if(!identical(sort(unique(data_aggregate$subject_id)), sort(unique(data_wide$subject_id)))) {
  stop("Bad processing")
}

data_aggregate <- data_aggregate %>%
  filter(N_drugs != 0 | N_adherent != 0)
```


```{r}
fit_aggregate_simple <- brm(N_adherent | vint(N_drugs) ~ 1 + cohort, data = data_aggregate, family = beta_binomial2, stanvars = stanvars_beta_binomial2, refresh = 500, file = paste0(cache_dir, "/fit_aggregate_simple"), file_refit = "on_change")

summary(fit_aggregate_simple)
```

```{r}
if(run_pp_checks) {
  preds <- posterior_predict(fit_aggregate_simple)
  preds_prop <- sweep(preds, MARGIN = 2, STATS = data_aggregate$N_drugs, FUN = "/")

  ppc_stat_grouped(data_aggregate$prop, yrep = preds_prop, group = data_aggregate$cohort)
  ppc_stat_grouped(data_aggregate$prop, yrep = preds_prop, group = data_aggregate$cohort, stat = sd)

    ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$sex)
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$sex, stat = sd)
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = cut(data_aggregate$age, 4))
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = cut(data_aggregate$age, 4), stat = sd)
  
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$NYHA)
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = data_aggregate$NYHA, stat = sd)
  
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = substr( replace_na(data_aggregate$EF, "NA"),1, 1)) + ggtitle("EF/10")
  ppc_stat_grouped(data_aggregate$prop, preds_prop, group = substr( replace_na(data_aggregate$EF, "NA"),1, 1), stat = sd)  + ggtitle("EF/10")
}
```


## Bad health

For the bad health model, we assume that both adherence and some clinical values (
VO2 max, NYHA, EF, NT-proBNP) are affected by the same construct of "bad health" - which is a one-dimensional quantity per subject. I.e. we don't expect a direct effect of say VO2 max on adherence, rather that VO2 max, NYHA, EF, NT-proBNP and adherence share the same unobserved causal factor.

Here is how the 4 clinical parameters correlate:

```{r}
#data_for_model1 %>% group_by(EF) %>% summarise(n())
data_wide %>% select(EF, VO2_max, NYHA, lab_NT_proBNP) %>% mutate(EF = as.integer(factor(EF)) + runif(n(), -0.1,0.1), NYHA = as.integer(factor(NYHA))  + runif(n(), -0.1,0.1), lab_NT_proBNP = log(lab_NT_proBNP)) %>% as.matrix() %>% pairs()
```

```{r}
# data_for_model1 %>% group_by(subject_id) %>%
#   summarise(prop_adherent = sum(adherent_int) /  n()) %>%
#   group_by(prop_adherent) %>%
#   summarise(n())
```

```{r}
repeated <- data_wide %>% 
  group_by(subject_id) %>% filter(n() > 1)

repeated %>% ggplot(aes(x = cohort, y = NYHA, group = subject_id)) + geom_line(position = position_jitter(width = 0.1, height = 0.1), alpha = 0.5)

repeated %>% ggplot(aes(x = cohort, y = EF, group = subject_id)) + geom_line(position = position_jitter(width = 0.1, height = 0.1), alpha = 0.5)

repeated %>% ggplot(aes(x = cohort, y = lab_NT_proBNP, group = subject_id)) + geom_line(alpha = 0.5) + scale_y_log10()
```


We can now fit the model

```{r}
mod_badhealth <- cmdstan_model("badhealth.stan")
```

```{r, results = 'hide'}
data_for_badhealth <- data_for_model1 %>% 
  mutate(measurement_id = paste(subject_id, cohort, sep = "_"),
         drug_class = factor(drug_class))

measurement_id_map <- 1:length(unique(data_for_badhealth$measurement_id))
names(measurement_id_map) <- unique(data_for_badhealth$measurement_id)

patient_data <- data_for_badhealth %>% 
  select(measurement_id,
         cohort,                                                             
         NYHA,
         VO2_max,
         EF,
         lab_NT_proBNP) %>%
  distinct() %>%
  mutate(measurement_id_model = measurement_id_map[measurement_id],
         NYHA = factor(NYHA),
         EF = factor(EF)) %>%
  arrange(measurement_id_model)

data_badhealth_stan <- list(
  N = nrow(data_for_badhealth),
  adherent = data_for_badhealth$adherent_int,
  N_classes = length(unique(data_for_badhealth$drug_class)),
  classes = data_for_badhealth$drug_class,
  N_measurements = length(measurement_id_map),
  measurement = measurement_id_map[as.character(data_for_badhealth$measurement_id)],
  N_NYHA = length(levels(patient_data$NYHA)),
  NYHA = patient_data$NYHA,
  VO2_max_missing = is.na(patient_data$VO2_max),
  VO2_max = replace_na(patient_data$VO2_max, 0),
  NT_proBNP_missing = is.na(patient_data$lab_NT_proBNP),
  NT_proBNP = replace_na(patient_data$lab_NT_proBNP, 0),
  N_EF = length(levels(patient_data$EF)),
  EF_missing = is.na(patient_data$EF),
  EF = replace_na(as.integer(patient_data$EF), 0),
  cohort = patient_data$cohort == "2020"
  
)

cache_file <- file.path(cache_dir, paste0("fit_badhealth_", rlang::hash(data_badhealth_stan), "_", rlang::hash(mod_badhealth$code())))
if(file.exists(cache_file)) {
  fit_badhealth <- readRDS(cache_file)
} else {
  fit_badhealth <- mod_badhealth$sample(data = data_badhealth_stan, refresh = 500)
  fit_badhealth$save_output_files(dir = cache_dir)
  saveRDS(fit_badhealth, file = cache_file)
}
  
```

Summarising the most important aspect of the fits:

```{r}
fit_badhealth$summary(variables = c("badhealth_slope", "nyha_thres", "VO2_max_slope", "NT_proBNP_slope", "EF_thres", "cohort_diff")) %>% knitr::kable()
```

we are primarily interested in the "badhealth_slope" variable, which is the association between bad health and adherence. We see that the 90% credible interval  is clearly positive, i.e. worse health is associated with increased adherence. Other parameters show the link between bad health and the other variables.

The value of the bad health hidden variable can be interpreted e.g by it's association to NYHA levels - the "nyha_thres" variables are the thresholds for NYHA levels (we observe 6 NYHA levels: `r paste0(levels(patient_data$NYHA), collapse = ", ")`). So bad health < -1.75 would be most often (but not always) associated with NYHA 1 while bad health between 1.9 and 4.4 would be associated with NYHA 3.


```{r}
badhealth_rvars <- posterior::as_draws_rvars(fit_badhealth$draws())

#pred_rvar_df <- tidybayes::spread_rvars(badhealth_rvars, class_intercept[drug_class], cohort_diff, badhealth_slope, adherent_intercept)

mean_bad_health <- mean(badhealth_rvars$badhealth)


#pred_df <- crossing(drug_class = 1:data_badhealth_stan$N_classes, cohort = c(0,1), badhealth = seq(min(mean_bad_health$badhealth), max(mean_bad_health$badhealth), length.out = 50))

pred_df <- crossing(data.frame(drug_class_id = 1:data_badhealth_stan$N_classes, drug_class = levels(data_for_badhealth$drug_class)), cohort = c(0,1), badhealth = seq(min(mean_bad_health), max(mean_bad_health), length.out = 50)) %>% 
  filter(cohort == 1 | (drug_class %in% both_cohorts_drugs))

pred_raw_rvar <-  badhealth_rvars$adherent_intercept  + badhealth_rvars$class_intercept[pred_df$drug_class_id] + badhealth_rvars$badhealth_slope * pred_df$badhealth + badhealth_rvars$cohort_diff * pred_df$cohort
pred_rvar <- posterior::rfun(plogis)(pred_raw_rvar)
pred_means <- mean(pred_rvar)
pred_qs <- quantile(pred_rvar, prob = c(0.025, 0.975))

pred_df_vals <- pred_df %>% mutate(pred = pred_means, low = pred_qs[1,], high = pred_qs[2,],
                              cohort = if_else(cohort == 0, "2018", "2020"),
                              )


                                        
adherence_for_pred <- data_for_badhealth %>% select(measurement_id, drug_class, adherent_int, cohort) %>% 
  mutate(measurement_id = measurement_id_map[measurement_id], badhealth = mean_bad_health[measurement_id])
```

```{r, fig.width=8, fig.height=8}
pred_df_vals %>% ggplot(aes(x = badhealth, y = pred, ymin = low, ymax = high, color = cohort, fill = cohort)) + geom_ribbon(alpha = 0.3, color = "transparent") + geom_line() + geom_point(aes(x = badhealth, y = adherent_int , shape = cohort, color = cohort), data = adherence_for_pred, inherit.aes = FALSE, position = position_jitter(height = 0.05), alpha = 0.5) +       scale_y_continuous("Proportion adherent", labels = scales::label_percent(),
                       breaks = c(0,0.5,1)) +
  scale_shape_cohort + scale_fill_cohort + scale_colour_cohort +
  facet_wrap(drug_class~cohort) 
```

```{r}
mean_NYHA_thres <- mean(badhealth_rvars$nyha_thres)

pred_overall_df <- crossing(cohort = c(0,1), badhealth = seq(min(mean_bad_health), max(mean_bad_health), length.out = 50))

pred_overall_raw_rvar <-  badhealth_rvars$adherent_intercept + badhealth_rvars$badhealth_slope * pred_overall_df$badhealth + badhealth_rvars$cohort_diff * pred_overall_df$cohort
pred_overall_rvar <- posterior::rfun(plogis)(pred_overall_raw_rvar)
pred_overall_means <- mean(pred_overall_rvar)
pred_overall_qs <- quantile(pred_overall_rvar, prob = c(0.025, 0.975))

pred_overall_df_vals <- pred_overall_df %>% mutate(pred = pred_overall_means, low = pred_overall_qs[1,], high = pred_overall_qs[2,],
                              cohort = if_else(cohort == 0, "2018", "2020"),
                              )


                                        
adherence_for_pred_overall <- data_for_badhealth %>% select(measurement_id, adherent_int, cohort) %>% group_by(measurement_id, cohort) %>% summarise(adherent = mean(adherent_int), .groups = "drop")  %>% 
  mutate(measurement_id = measurement_id_map[measurement_id], badhealth = mean_bad_health[measurement_id])
```

```{r}
nyha2_index <- which(levels(data_for_badhealth$NYHA) == "2") 

pred_overall_df_vals %>% ggplot(aes(x = badhealth, y = pred, ymin = low, ymax = high, color = cohort, fill = cohort)) + geom_ribbon(alpha = 0.3, color = "transparent") + geom_line() + geom_point(aes(x = badhealth, y = adherent , shape = cohort, color = cohort), data = adherence_for_pred_overall, inherit.aes = FALSE, position = position_jitter(height = 0.05), alpha = 0.5) +       scale_y_continuous("Proportion adherent", labels = scales::label_percent(),
                       breaks = c(0,0.5,1)) +
  scale_shape_cohort + scale_fill_cohort + scale_colour_cohort +
  facet_wrap(~cohort) 
```

```{r}
badhealth_for_pred = seq(min(mean_bad_health), max(mean_bad_health), length.out = 50)

n_draws_for_pred <- posterior::ndraws(badhealth_rvars$adherent_intercept)
cdf_nyha <- array(NA_real_, dim = c(data_badhealth_stan$N_NYHA + 1, n_draws_for_pred,
                                     length(badhealth_for_pred)))

cdf_nyha[1,,] <- 0

for(i in 1:(data_badhealth_stan$N_NYHA - 1)) {
  rep_thres <- matrix(posterior::draws_of(badhealth_rvars$nyha_thres[i]), nrow = n_draws_for_pred, ncol = length(badhealth_for_pred))
  rep_badhealth <- matrix(badhealth_for_pred, byrow = TRUE, nrow = n_draws_for_pred, ncol = length(badhealth_for_pred))

  cdf_nyha[i + 1,,] <-  plogis(rep_thres - rep_badhealth)
}

cdf_nyha[data_badhealth_stan$N_NYHA + 1, , ] <- 1
prob_nyha <- apply(cdf_nyha, MARGIN = c(2,3), FUN = diff)

mean_nyha <- apply(sweep(prob_nyha, MARGIN = 1, STATS = 1:data_badhealth_stan$N_NYHA, FUN = "*"), FUN = sum, MARGIN = c(2,3))

pred_mean_nyha <- apply(mean_nyha, FUN = mean, MARGIN = 2) 
pred_q_nyha <- apply(mean_nyha, FUN = quantile, MARGIN = 2, probs = c(0.025, 0.975)) 


obs_nyha_for_pred <- data.frame(NYHA = as.integer(data_badhealth_stan$NYHA), badhealth = mean_bad_health, cohort = if_else(data_badhealth_stan$cohort == 0, "2018", "2020")) 

data.frame(badhealth = badhealth_for_pred, NYHA = pred_mean_nyha, low = pred_q_nyha[1,], high = pred_q_nyha[2,]) %>%
  ggplot(aes(x = badhealth, y = NYHA)) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.3, fill = "blue") +
  geom_line(color = "blue") +
  geom_point(aes(shape = cohort, color = cohort), data = obs_nyha_for_pred, position = position_jitter(height = 0.1), alpha = 0.5) +
  scale_colour_cohort + scale_shape_cohort +
  scale_y_continuous("NYHA", breaks = 1:data_badhealth_stan$N_NYHA, labels = levels(data_for_badhealth$NYHA))

#TODO možná přímo zobrazit CDF?
```

```{r}
linpred_NT_proBNP <- badhealth_rvars$NT_proBNP_intercept + badhealth_for_pred * badhealth_rvars$NT_proBNP_slope

qlnorm_rvar <- posterior::rfun(qlnorm)

pred_NT_proBNP <- data.frame(
  badhealth = badhealth_for_pred,
  NT_proBNP = mean(exp(linpred_NT_proBNP)),
  low = mean(qlnorm_rvar(0.025, linpred_NT_proBNP, badhealth_rvars$NT_proBNP_sd)),
  high = mean(qlnorm_rvar(0.975, linpred_NT_proBNP, badhealth_rvars$NT_proBNP_sd))
)

obs_NT_proBNP_for_pred <- data.frame(NT_proBNP = data_badhealth_stan$NT_proBNP, badhealth = mean_bad_health, cohort = if_else(data_badhealth_stan$cohort == 0, "2018", "2020")) %>%
  filter(!data_badhealth_stan$NT_proBNP_missing)

pred_NT_proBNP %>%
  ggplot(aes(x = badhealth, y = NT_proBNP)) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.3) +
  geom_line() +
  geom_point(aes(shape = cohort, color = cohort), data = obs_NT_proBNP_for_pred, alpha = 0.5) +
  scale_colour_cohort + scale_shape_cohort +
  scale_y_log10("NT_proBNP")
```


TODO: maybe show difference in adherence from "best" to "worst" patient?

```{r}
worst_health_model_ids <- fit_badhealth$summary(variables = "badhealth") %>% arrange(desc(q5)) %>% slice_head(n = 5) %>% pull(variable) %>%
  gsub("badhealth\\[|\\]", "", .)
worst_health_measurement_ids <- sort(names(measurement_id_map[measurement_id_map %in% worst_health_model_ids]) )
```

The model assumes the worst health is observed in patients ID `r worst_health_measurement_ids`.

```{r}
if(run_pp_checks) {
  linpred_adherent <- badhealth_rvars$adherent_intercept + badhealth_rvars$class_intercept[data_badhealth_stan$classes] + 
    badhealth_rvars$badhealth_slope * badhealth_rvars$badhealth[data_badhealth_stan$measurement] 
  
  epred_adherent <- posterior::rdo(plogis(linpred_adherent))
  
  pred_adherent <- posterior::draws_of(posterior::rvar_rng(rbinom, n = data_badhealth_stan$N, prob = epred_adherent, size = 1))
}
```

```{r}
if(run_pp_checks) {
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = data_for_badhealth$sex)
  
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = cut(data_for_badhealth$age, 4))
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = data_for_badhealth$NYHA)
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = replace_na(as.character(cut(data_for_badhealth$VO2_max, 4)), "NA"))
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = cut(log(replace_na(data_for_badhealth$lab_NT_proBNP, 0.0001)), 4))
  
  
  
  ppc_bars_grouped(data_badhealth_stan$adherent, pred_adherent, group = replace_na(substr( data_for_badhealth$EF,1, 1), "NA")) + ggtitle("EF/10")
}
```

```{r}
if(run_pp_checks) {
  linpred_NT_proBNP <- badhealth_rvars$NT_proBNP_intercept + badhealth_rvars$NT_proBNP_slope * badhealth_rvars$badhealth

  pred_NT_proBNP <- posterior::draws_of(posterior::rvar_rng(rlnorm, n = data_badhealth_stan$N_measurements,  linpred_NT_proBNP, badhealth_rvars$NT_proBNP_sd))

  
  ppc_dens_overlay(log(data_badhealth_stan$NT_proBNP), log(pred_NT_proBNP[sample(1:4000, 50),]))
  ppc_dens_overlay_grouped(log(data_badhealth_stan$NT_proBNP), log(pred_NT_proBNP[sample(1:4000, 50),]), group = fct_collapse(patient_data$NYHA, "3-4" = c("3", "3-4")))
  
  badhealth_noised <- posterior::rvar_rng(rlogis, n = data_badhealth_stan$N_measurements, location = badhealth_rvars$badhealth)
  pred_NYHA <- 1
  for(i in 1:dim(badhealth_rvars$nyha_thres)) {
    pred_NYHA <- pred_NYHA + (badhealth_noised > badhealth_rvars$nyha_thres[i])
  }
  
  pred_NYHA <- posterior::draws_of(pred_NYHA)

    obs_NYHA <- as.integer(data_badhealth_stan$NYHA)
  
  ppc_bars(obs_NYHA, pred_NYHA)
  ppc_bars_grouped(obs_NYHA[!data_badhealth_stan$NT_proBNP_missing], pred_NYHA[,!data_badhealth_stan$NT_proBNP_missing], group = cut(log(data_badhealth_stan$NT_proBNP[!data_badhealth_stan$NT_proBNP_missing]), 4))
}
```

```{r}
if(run_pp_checks) {
  pred_EF <- 1
  for(i in 1:dim(badhealth_rvars$EF_thres)) {
    pred_EF <- pred_EF + (badhealth_noised > badhealth_rvars$EF_thres[i])
  }
  
  obs_EF <- as.integer(data_badhealth_stan$EF)
  pred_EF <- posterior::draws_of(pred_EF)[,!data_badhealth_stan$EF_missing]
  obs_EF <- obs_EF[!data_badhealth_stan$EF_missing]
  
  ppc_bars(obs_EF, pred_EF)
  ppc_bars_grouped(obs_EF, pred_EF, group = cut(log(patient_data$lab_NT_proBNP[!data_badhealth_stan$EF_missing]), 3))
}
```


## Mortality



## Adherence questionnaire

Q1, Q3, Q4 - affirmitive answer -> less adherence
Q2 - affirmitive answer -> more adherence

First, let's try a model excluding Q3 and Q4

```{r}
data_questionnaire <- data_for_model1 %>% 
  filter(cohort == "2020") %>% 
  mutate(questionnaire_2_r = 1 - questionnaire_2, questionnaire_4 = replace_na(questionnaire_4, 0))

priors_questionnaire <- c(priors1, prior(normal(0,2), class = "b"))

formula_questionnaire <- brmsformula(adherent_int ~ (1 | drug_class) + questionnaire_1 + questionnaire_2, family = "bernoulli")

fit_questionnaire <- brm(formula_questionnaire, data = data_questionnaire, prior = priors_questionnaire, 
            file = paste0(cache_dir, "/fit_questionnaire"), file_refit = "on_change", refresh = 500)

summary(fit_questionnaire)

```

```{r}
questionnaire_rvars <- posterior::as_draws_rvars(fit_questionnaire)
prob_q1 <- mean(questionnaire_rvars$b_questionnaire_1 < 0 )
prob_q2 <- mean(questionnaire_rvars$b_questionnaire_2 > 0 )
prob_both <- mean(questionnaire_rvars$b_questionnaire_1 < 0 & questionnaire_rvars$b_questionnaire_2 > 0)

prob_neither <- mean(questionnaire_rvars$b_questionnaire_1 > 0 & questionnaire_rvars$b_questionnaire_2 < 0)

```

We are left with substantial uncertainty about even the sign (let alone magnitude) of the association between Q1, Q2 and adherence. Our posterior probability that the association is positive for Q1 is `r scales::percent(prob_q1)` (as one would expect). For Q2 the association is to be expected to be negative and our posterior probability that it actually is negative is `r scales::percent(prob_q2)`. The probability that both associations are in the expected direction is `r scales::percent(prob_both)`, but we find it unlikely that neither would go in the expected direction (posterior probability is `r scales::percent(prob_neither, accuracy = 2)`)

Another way to look at the same result is to predict the expected absolute difference in adherence for a group of patients that responded to both questions by indicating high adherence and a group of patients responded to both questions by indicating low adherence. While our model assumes the same relative effect on the log odds scale for all drugs, the absolute effect can differ between drugs due to their differing baseline adherence. Here's a graphical summary showing the posterior distribution and the central 50% and 95% credible intervals:

```{r}
q_pred <- crossing(data.frame(drug_class = c("BB", "ARNI", "statin")),
                   data.frame(questionnaire_1 = c(0, 1), questionnaire_2 = c(1,0), label = factor(c(1,2), levels = 2:1, labels = c("Low", "High")))) %>% tidybayes::add_epred_draws(fit_questionnaire) %>%
  group_by(drug_class, .draw) %>%
  mutate(epred_diff = .epred[label == "High"] - .epred[label == "Low"]) %>%
  ungroup()

q_pred %>%  
  ggplot(aes(x = epred_diff, y = drug_class)) + 
  geom_vline(xintercept = 0, color = "blue") +
  stat_halfeye() + 
  scale_x_continuous("Absolute adherence difference", labels = scales::percent) +
  scale_y_discrete("Drug class")

```

Numerically, the same results are:

```{r}
q_pred %>% group_by(drug_class) %>%
  summarise(`Expected adherence difference` = scales::percent(mean(epred_diff)),
            `95% CI` = paste0("(",scales::percent(quantile(epred_diff, prob = 0.025)), "; ", scales::percent(quantile(epred_diff, prob = 0.975)), ")"))
            
```

So we have substantial uncertainty about the association of the questions with adherence outcome.




```{r}
# The results don't really change with an aggreagte model, commenting out

# fit_questionnaire_aggregate <- brm(N_adherent | vint(N_drugs) ~ 1 + questionnaire_1 + questionnaire_2, 
#                                    data = data_aggregate, 
#                                    family = beta_binomial2, 
#                                    stanvars = stanvars_beta_binomial2, refresh = 500,
#                                    prior = prior(normal(0,2), class = "b"),
#                                    file = paste0(cache_dir, "/fit_questionnaire_aggregate"), file_refit = "on_change")
# 
# summary(fit_questionnaire_aggregate)
```

# Cholesterol, liver

```{r}
plot_adherence_by_continuous(data_long, cholesterol_total)
plot_adherence_by_continuous(data_long, TAG)
plot_adherence_by_continuous(data_long, log(HDL_C))
plot_adherence_by_continuous(data_long, LDL_C)
plot_adherence_by_continuous(data_long, non_HDL)

```

```{r}
data_wide_a <- data_wide %>% 
  filter(!(subject_id %in% subject_id_no_drugs)) %>%
  inner_join(data_adherent_cat, by = c("subject_id", "cohort"),
             relationship = "one-to-one", unmatched = "error")

if(nrow(data_wide_a) != nrow(data_wide) - length(subject_id_no_drugs)) {
  stop("Bad join")
}
```


```{r}
adherent_diagnosis_contingency <- data_wide_a %>% group_by(category_bin, diagnosis_group) %>%
  tally() %>%
  pivot_wider(names_from = "diagnosis_group", values_from = "n") %>%
  column_to_rownames("category_bin") %>%
  as.matrix()


adherent_diagnosis_contingency

chisq.test(adherent_diagnosis_contingency, simulate.p.value = TRUE)
```
